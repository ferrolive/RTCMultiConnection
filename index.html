<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta charset="utf-8">
  <link rel="icon" href="data:;base64,=">
  <meta name="robots" content="noindex" />
  <title>Video Call</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <link href="https://fonts.googleapis.com/css?family=Dosis:400,500,700" rel="stylesheet" type="text/css">  
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<h1 style="text-align: center;"></h1>

<section class="make-center" id="master-wrapper" style="display:none;">
    <div id="room-wrap" style="display:nonex;">
        <input type="text" id="room-id" value="abcdef" autocorrect=off autocapitalize=off size=20 style="display:nonex;">
        <button id="open-room" style="display:nonex;">Open Room</button>
        <button id="join-room" style="display:nonex;">Join Room</button>
    </div>

    <br><br>
    <button id="share-file" style="display:none;" disabled>Share File</button>
    <br><br>

    <div id="room-urls" style="text-align: center;display: none;background: #F1EDED;margin: 15px -10px;border: 1px solid rgb(189, 189, 189);border-left: 0;border-right: 0;"></div>
</section>

<style>
.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
  -webkit-animation-name: fadeIn; /* Fade in the background */
  -webkit-animation-duration: 0.4s;
  animation-name: fadeIn;
  animation-duration: 0.4s
}

/* Modal Content/Box */
.modal-content {
  background-color: #fefefe;
  margin: 15% auto; /* 15% from the top and centered */
  padding: 20px;
  border: 1px solid #888;
  width: 30% !important; /* Could be more or less, depending on screen size */
  text-align: center;
}

/* The Close Button */
.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: black;
  text-decoration: none;
  cursor: pointer;
}
.expired-wrapper {
    display: none;
}
</style>

<div id="myModal" class="modal">
  <!-- Modal content -->
  <div class="modal-content">
    <div id="call-wrapper"></div>

    <div class="expired-wrapper"></div>
  </div>
</div>
<script>
var modal = document.getElementById("myModal");

// // When the user clicks on <span> (x), close the modal
// span.onclick = function() {
//   modal.style.display = "none";
// }

// When the user clicks anywhere outside of the modal, close it
// window.onclick = function(event) {
//   if (event.target == modal) {
//     modal.style.display = "none";
//   }
// }
</script>


<div class="container">
    <div class="row">
        <div class="col">
            <img src="./resources/img/logo.png" id="logo-img" style="height: 55px;padding-top:15px;"/>
        </div>
        <div class="col">
            <button id="open-or-join-room" style="display:none;" class="btn btn-success btn-sm">
                <div class="icon sbicon-phone"></div>
            </button>
            <button id="btn-leave-room" class="btn btn-danger btn-sm" style="display:none;" disabled>End Call</button>

            <button id="accept-call" style="display:none;float:left;" class="btn btn-success btn-sm">
                <div class="icon sbicon-phone">&nbsp;Accept Call</div>
            </button>

            
            <!-- CALL BUTTON -->
            <button id="end-call" style="float:right;margin:5px;display:none;" class="btn btn-danger btn-round btn-lg"></button>
            <button id="call-audio" style="float:right;margin:5px;" class="btn btn-success btn-round btn-lg" disabled></button>
            <button id="call-video" style="float:right;margin:5px;" class="btn btn-success btn-round btn-lg" disabled></button>

            <button id="hide-video" style="display:none;float:right;margin:5px" class="btn btn-danger btn-circle btn-lg btn-sm">
                <div class="icon sbicon-video-camera"></div>
            </button>

            <!-- MUTE BUTTON -->
            <button id="mute-audio" style="display:none;float:right;margin:5px" class="btn btn-danger btn-circle btn-lg">
                <div class="icon sbicon-microphone-slash"></div>
            </button>

            <button id="unmute-audio" style="display:none;float:right;margin:5px" class="btn btn-success btn-circle btn-lg">
                <div class="icon sbicon-microphone"></div>
            </button>     

            <button id="toggle-video" status="no" style="display:none;float:right;margin:5px" class="btn btn-success btn-circle btn-lg btn-sm">
                <div class="icon sbicon-video-camera"></div>
            </button>

        </div>
    </div>
    <hr/>
    <style>
        #videos-container {
            border-radius: 10px; 
            min-height:480px;
            background-image: url('./resources/img/bg.png');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: 80%;
        }
    </style>   
    <div class="grid"> 
        <div class="col-8_sm-12" id="videos-container"></div>
        <div class="col">
            <div style="text-align: center;padding-bottom: 10px;" id="status-call"></div>
            <div id="chat-container" style="max-height:520px; overflow:scroll; overflow-x: auto;">
                <div class="chat-output"></div>
            </div>
            <input type="text" id="input-text-chat" class="form-control" placeholder="Enter Text Chat" disabled>
        </div>
    </div>
</div>

<script>
    var local_name = null;
    var remote_name = null;
    var local_tz = null;
    var remote_tz = null;
    var saveLogs = false;
    window.getExternalIceServers = true;
</script>
<!-- <script src="https://cdn.webrtc-experiment.com/getStats.js"></script> -->
<script src="/dev/getStats.min.js"></script>
<script src="/dev/IceServersHandler.js"></script>
<script src="/dist/RTCMultiConnection.js"></script>
<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
<script src="hark.js"></script>
<script src="/dev/lang.js"></script>
<script src="/dev/moment-with-locales.js"></script>
<script src="/dev/moment-timezone-with-data-1970-2030.js"></script>

<!-- custom layout for HTML5 audio/video elements -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gridlex/2.7.1/gridlex.min.css">
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<link rel="stylesheet" href="/dev/getHTMLMediaElement.css">
<script src="/dev/getHTMLMediaElement.js"></script>
<script src="/dev/FileBufferReader.js"></script>
<script>
var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
var isFirefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;
window.enableAdapter = true; // enable adapter.js

var myAudio = new Audio('ring.mp3'); 
function sound2($status="play") {
    if (typeof myAudio.loop == 'boolean'){
        myAudio.loop = true;
    }else{
        myAudio.addEventListener('ended', function() {
            this.currentTime = 0;
            if ($status == "play") {
                this.play();    
            } else {
                this.pause();
            }
        }, false);
    }
    if ($status == "play") {
        myAudio.play();
    } else {
        myAudio.pause();
    }
}

// ......................................................
// .......................UI Code........................
// ......................................................
document.getElementById('open-room').onclick = function() {
    disableInputButtons();
    connection.open(document.getElementById('room-id').value, function() {
    });
};

document.getElementById('join-room').onclick = function() {
    disableInputButtons();
    connection.join(document.getElementById('room-id').value);
};

document.getElementById('open-or-join-room').onclick = function() {
    disableInputButtons();
    connection.openOrJoin(document.getElementById('room-id').value, function(isRoomExists, roomid) {
        if (!isRoomExists) {
        }
    });
};

document.getElementById('btn-leave-room').onclick = function() {
    this.disabled = true;

    if (connection.isInitiator) {
        // use this method if you did NOT set "autoCloseEntireSession===true"
        // for more info: https://github.com/muaz-khan/RTCMultiConnection#closeentiresession
        connection.closeEntireSession(function() {
            document.querySelector('h1').innerHTML = 'Entire session has been closed.';
        });

        alert('initiator left room');
    } else {
        connection.leave();

        alert('someone left room');
    }
};

// ......................................................
// ................FileSharing/TextChat Code.............
// ......................................................

document.getElementById('share-file').onclick = function() {
    var fileSelector = new FileSelector();
    fileSelector.selectSingleFile(function(file) {
        connection.send(file);
    });
};

var numberOfKeys = 0;
var lastMessageUUID;

document.getElementById('input-text-chat').onkeyup = function(e) {
    numberOfKeys++;

    if (numberOfKeys > 3) {
        numberOfKeys = 0;
    }

    if (!numberOfKeys) {
        if (!lastMessageUUID) {
            lastMessageUUID = Math.round(Math.random() * 999999999) + 9995000;
        }

        connection.send({
            typing: true,
            lastMessageUUID: lastMessageUUID
        });
    }

    if (!this.value.replace(/^\s+|\s+$/g, '').length) {
        connection.send({
            stoppedTyping: true,
            lastMessageUUID: lastMessageUUID
        });
        return;
    }

    if (e.keyCode != 13) return;

    // removing trailing/leading whitespace
    this.value = this.value.replace(/^\s+|\s+$/g, '');

    if (this.value.split(" ").includes("skype")) {
        alert('sorry, you cant use this word');
    }
    
    //if (!this.value.length) return;

    connection.send({
        message: this.value,
        lastMessageUUID: lastMessageUUID
    });

    var remotepeer = connection.extra.name;
    if (remotepeer === remote_name ) {
        appendDIV(this.value, lastMessageUUID, remote_name, remote_tz);
    } else {
        appendDIV(this.value, lastMessageUUID, local_name, local_tz);
    }
    lastMessageUUID = null;
    this.value = '';
};

var chatContainer = document.querySelector('.chat-output');

function appendDIV(event, messageUUID, user=null, tz=null) {
    var existing = false, div, datespan;

    datespan = document.createElement('span'); 
    if (document.getElementById(messageUUID)) {
        div = document.getElementById(messageUUID);
        existing = true;
    } else {        
        div = document.createElement('div');
        if (messageUUID) {
            div.id = messageUUID;
        }
    }

    if (user==null) {
        user = remote_name;
        div.style = "padding:2px;margin-bottom:2px;";  //display:table;
    } else {
        div.style = "color:#838383;font-style:italic;padding:2px;margin-bottom:2px;";   // display:table;
        //addMessage(event.data || event); //save db 
    }

    if (false) {
        try {
            //div.innerHTML = user + ": " + (event.data || event);
            div.innerHTML = (event.data || event);
        }catch(e){
            div.innerHTML = (event);
            console.log("err:",e)
        }    
    } else {
        if (typeof event.data === "undefined") {
            div.innerHTML = (event);
        } else {
            div.innerHTML = (event.data || event);
        }
    }
    
    if (tz) {
        var times = new Date();
        var datex = toTimeZone(times,tz);
        datespan.innerHTML = datex;
        datespan.style = "margin-top:6px;";
        datespan.style.fontSize = "11px";
        datespan.style.cssFloat = "right";
    }

    if (!existing) {
        chatContainer.parentNode.insertBefore(div, chatContainer.firstChild);
        //chatContainer.insertBefore(div, chatContainer.firstChild);
    }

    if (tz) {
        div.appendChild(datespan);
    }
    
    div.tabIndex = 0;
    div.focus();

    document.getElementById('input-text-chat').focus();
}

function modify(lastMessageUUID, modifiedValue) {
    connection.send({
        message: modifiedValue,
        lastMessageUUID: lastMessageUUID,
        modified: true
    });
}

function remove(lastMessageUUID) {
    connection.send({
        lastMessageUUID: lastMessageUUID,
        removed: true
    });
}

// ......................................................
// ..................RTCMultiConnection Code.............
// ......................................................

var connection = new RTCMultiConnection();

connection.onSocketDisconnect(function() {
    alert('socket was disconnected, please connect again');
});

// by default, socket.io server is assumed to be deployed on your own roomURLsDiv
// comment-out below line if you do not have your own socket.io server
connection.socketURL = '/';

connection.socketMessageEvent = 'audio-video-file-chat-sb';

connection.enableFileSharing = true; // by default, it is "false".

connection.session = {
    audio: true,
    video: true,
    data: true
};

connection.mediaConstraints = {
    video: true,
    audio: true
};

// connection.iceServers = [];
// getIce();

var forceTURN = true;
if (forceTURN) {
    connection.candidates = {
        turn: true,
        stun: false,
        host: false
    };
    connection.iceTransportPolicy = 'relay';
} else {
    connection.candidates = {
        turn: true,
        stun: true,
        host: true
    };
    connection.iceTransportPolicy = 'all';
}

// connection.bandwidth = {
//     audio: 50,  // 50 kbps
//     video: 256 // 256 kbps
// };

connection.processSdp = function(sdp) {return sdp;};
connection.optionalArgument = {}; // ignore all DTLS/ipv6 parameters
//connection.trickleIce=false;

connection.dontCaptureUserMedia = true;
//connection.dontAttachStream = true;
//connection.dontGetRemoteStream = true;

connection.sdpConstraints.mandatory = {
    OfferToReceiveAudio: true,
    OfferToReceiveVideo: true
};

connection.videosContainer = document.getElementById('videos-container');

connection.setUserPreferences = function(userPreferences) {
    if (connection.dontAttachStream) {
        // current user's streams will NEVER be shared with any other user
        userPreferences.dontAttachLocalStream = false;
    }

    if (connection.dontGetRemoteStream) {
        // current user will NEVER receive any stream from any other user
        userPreferences.dontGetRemoteStream = false;
    }
    return userPreferences;
};

connection.onstream = function(event) {
    event.mediaElement.removeAttribute('src');
    event.mediaElement.removeAttribute('srcObject');    

    document.getElementById('mute-audio').style.display = "";

    if (event.stream.isScreen) {
        console.log('is screen');
    }

    if (event.stream.isAudio) {
        console.log('is audio');
    }

    if (event.stream.isVideo) {
        if (event.stream.getAudioTracks().length && event.stream.getVideoTracks().length) {
            console.log('is audio+video');
        } else {
            console.log('is video');
        }

    }

    if (event.stream.isVideo) {
        var video = document.createElement('video');
        video.controls = false;
        video.autoplay = true;
        video.playsinline = true;

        if(event.type === 'local') {
            video.muted = true;
            local_name = event.extra.name;
            video.style = "border-radius:10px;transform: rotateY(180deg);-webkit-transform:rotateY(180deg);-moz-transform:rotateY(180deg);position:absolute;width:180px;z-index:6;top:130px; left:180px;";
            //connection.changeUserId(event.extra.user_id);            
        }
        video.srcObject = event.stream;

        var videoNew = document.getElementById(video.id);
        if (videoNew) {
            //video.replaceWith(event.mediaElement);
            event.mediaElement.pause();
            video.srcObject = event.stream;
        } else {
            connection.videosContainer.appendChild(video);
        }

         setTimeout(function() {
            //video.media.play();
            video.play();
            //connection.videosContainer.style = "background-color: #fff !important;";
            // var promise = video.play();

            // if (promise !== undefined) {

            //   promise.then(_ => {
            //     //console.log('started');
            //   }).catch(error => {
            //     //console.log('autoplay prevented');
            //     //console.log('show a play, so user acn decide');
            //   });

            // }

        }, 4000);

        // for iOS Safari
        document.addEventListener('touchstart', function(e) {
            var element = e.target;
            if(element.id == event.streamid){
                element.play();
            }        
        }, false);

        video.id = event.streamid;
        video.setAttribute('data-userid', event.userid);

        if (event.type === 'remote') {
            video.style = "width: 100% !important;";
            video.style.borderRadius = "10px";        
        }

        video.onclick = function() {
            var streamid = this.id;
            var userid = this.getAttribute('data-userid');
            //var allVideosComingFromThisUser = connection.peers[userid].peer.getRemoteStreams();
            var streamEvent = connection.streamEvents[streamid];
            console.log(streamEvent.type, streamEvent.stream.isScreen, streamEvent.stream, streamEvent.mediaElement);
        }

    }
    
    if (event.type === 'remote') {
        var heJoinedAt = new Date(event.extra.joinedAt).getTime();
        var currentDate = new Date().getTime();
        var latency = currentDate - heJoinedAt;
        remote_name = event.extra.name;
    }

    // allow drag-and-drop for local video
    dragElement(document.getElementById(event.streamid));

    initHark({
        stream: event.stream,
        streamedObject: event,
        connection: connection
    });

};

connection.onspeaking = function (e) {
    // e.streamid, e.userid, e.stream, etc.
    //e.mediaElement.style.border = '1px solid red';
    var element_mute = document.getElementById('mute-audio');
    element_mute.style.border = '3px solid #E8AEB2';
};

connection.onsilence = function (e) {
    // e.streamid, e.userid, e.stream, etc.
    //e.mediaElement.style.border = '';
    var element_mute = document.getElementById('mute-audio');
    element_mute.style.border = '3px solid #dc3545';
};

connection.onvolumechange = function(event) {
    event.mediaElement.style.borderWidth = event.volume;
};

function initHark(args) {
    if (!window.hark) {
        throw 'Please link hark.js';
        return;
    }

    var connection = args.connection;
    var streamedObject = args.streamedObject;
    var stream = args.stream;
    var options = {};
    var speechEvents = hark(stream, options);

    speechEvents.on('speaking', function() {
        connection.onspeaking(streamedObject);
    });

    speechEvents.on('stopped_speaking', function() {
        connection.onsilence(streamedObject);
    });

    speechEvents.on('volume_change', function(volume, threshold) {
        streamedObject.volume = volume;
        streamedObject.threshold = threshold;
        connection.onvolumechange(streamedObject);
    });
}

function createStreams() {
    connection.addStream({
        video: true,
        oneway: true
    });
    return;
}

function endStreams() {
    connection.attachStreams.forEach(function(stream) {
        stream.stop();
        return;
    });
}

connection.onunmute = function(e) {

    //console.log("onunmute",e);
    if (e.type === 'remote') {

        var mutetag = document.getElementById("mutetag");
        if (mutetag) {
            mutetag.innerHTML = "";
        }

    }

}

connection.onmute = function(e) {

    console.log("onmute",e);

    if (e.type === 'remote') {

        var mutetag = document.getElementById("mutetag");

        if (mutetag) {
            mutetag.innerHTML = "MUTE";
        } else {

            var mutetag = document.createElement("div");
            mutetag.id = "mutetag";
            mutetag.innerHTML = "MUTE";
            connection.videosContainer.appendChild(mutetag);

        }

        

        //e.mediaElement.srcObject = null;
        //e.mediaElement.setAttribute('poster', 'photo.jpg');
        //alert(e.userid);
    }
    // if (e.muteType === 'both' || e.muteType === 'video') {
    //     e.mediaElement.src = null;
    //     e.mediaElement.pause();
    //     e.mediaElement.poster = e.snapshot || 'https://cdn.webrtc-experiment.com/images/muted.png';
    // } else if (e.muteType === 'audio') {
    //     e.mediaElement.muted = true;
    // }
}

// document.getElementById('new-open-video').onclick = function() {
//     createStreams();  //comment here
//     connection.send({
//         startcall: true,            
//     });
//     // this.style.display = "none";
//     // document.getElementById('hide-video').style.display = "";
// }

document.getElementById('call-video').onclick = function() {
    //createStreams();  //comment here
    connection.send({
        startcall: true,            
    });
    // this.style.display = "none";
    // document.getElementById('hide-video').style.display = "";
}

document.addEventListener("click", mainListener);

function mainListener(event){
    var element = event.target;
    if(element.id == 'accepting-call'){        
        element.style.display = "none";

        // connection.dontAttachStream = false;
        // connection.renegotiate();

        createStreams();
        sound2('stop');
        modal.style.display = "none"; //hide modal

        document.getElementById('end-call').style.display = "";
        document.getElementById('call-video').style.display = "none";
        document.getElementById('call-audio').style.display = "none";
        document.getElementById('toggle-video').style.display = "";

        connection.send({
            callaccepted: true,
        });
    }

    if(element.id == 'refuse-call'){
        element.style.display = "none";
        sound2('stop');
        modal.style.display = "none"; //hide modal
    }

    if(element.id == 'accepting-audio'){
        sound2('stop');
        modal.style.display = "none"; //hide modal

        connection.mediaConstraints = {
            video: false,
            audio: true
        };
        connection.addStream({
            video: false,
            audio: true,
            oneway: true
        });

        document.getElementById('toggle-video').style.display = "";
        connection.send({
            audioaccepted: true
        });        

        document.getElementById('call-audio').style.display = "none";
        document.getElementById('call-video').style.display = "none";
        document.getElementById('end-call').style.display = "";
        
    }
    
}



document.getElementById('hide-video').onclick = function() {    
    endStreams();
    connection.send({
        endStreamForAll: true,            
    });
    this.style.display = "none";
    //document.getElementById('new-open-video').style.display = "block";
}


document.getElementById('end-call').onclick = function() {    
    endStreams();
    connection.send({
        endStreamForAll: true,            
    });
    this.style.display = "none";

    document.getElementById('toggle-video').style.display = "none";
    document.getElementById('call-video').style.display = "";
    document.getElementById('call-audio').style.display = "";    
    document.getElementById('mute-audio').style.display = "none";
}



document.getElementById('call-audio').onclick = function() {
    connection.send({ audioCall: true });
    connection.mediaConstraints = {
        video: false,
        audio: true
    };
    connection.addStream({
        video: false,
        audio: true,
        oneway: true
    });
    return;
}

document.getElementById('toggle-video').onclick = function() {

    var attr = this.getAttribute("status");

    if (attr=="no") {

        this.classList.remove('btn-success');
        this.classList.add('btn-danger');
        this.setAttribute("status", "yes");

        var tag = this.getElementsByTagName('div')[0];
        tag.classList.remove('sbicon-video-camera');
        tag.classList.add('sbicon-slash-cam');
        
        connection.mediaConstraints.video = true;
        connection.mediaConstraints.audio = false;
        connection.removeStream();
        connection.addStream({
            video: true,
            audio: false
        });
        connection.renegotiate();

    } else {

        this.classList.remove('btn-danger');
        this.classList.add('btn-success');
        this.setAttribute("status", "no");
        
        var tag2 = this.getElementsByTagName('div')[0];
        tag2.classList.remove('sbicon-slash-cam');  
        tag2.classList.add('sbicon-video-camera');

        connection.attachStreams.forEach(function(stream) {
            //stream.stop();
            connection.removeStream(stream.id);
            connection.renegotiate();
            return;
        });

    }

    return;
}


//get streamID
// connection.streamEvents.selectFirst({local:true}).streamid

//get userID
//connection.streamEvents.selectFirst({local:true}).userid


document.getElementById('mute-audio').onclick = function() {

    connection.attachStreams.forEach(function(stream) {
        stream.mute("audio");
        return;
    });
    
    this.style.display = "none";
    document.getElementById('unmute-audio').style.display = "";

} 

document.getElementById('unmute-audio').onclick = function() {

    connection.attachStreams.forEach(function(stream) {
        stream.unmute("audio");
        return;
    });
    
    this.style.display = "none";
    document.getElementById('mute-audio').style.display = "";
} 





connection.onstreamended = function(event) {
    // var mediaElement = document.getElementById(event.streamid);
    // if (mediaElement) {
    //     mediaElement.parentNode.removeChild(mediaElement);
    // }
    var video = document.getElementById(event.streamid);
    if (video && video.parentNode) {
        video.parentNode.removeChild(video);
    }

    //alert('a');
};

function insertAfter(newNode, referenceNode) {
    referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
}


connection.onmessage = function(event) {

    if (event.data.startcall) {

        modal.style.display = "block"; //show modal
        
        var btncall = document.getElementById("accepting-call");
        var btnend = document.getElementById("refuse-call");
        var item = document.getElementById('call-wrapper');
        var icon = document.createElement('div');
        icon.className = "icon sbicon-video-camera";

        if (btncall) {
            sound2(); //ringtone
            btncall.style.display = "inline-block";
            
        } else {
            var buttonCall = document.createElement('button');
            buttonCall.className = "btn btn-success btn-circle btn-lg btn-sm";
            buttonCall.id = "accepting-call";
            // buttonCall.appendChild(icon);
            item.appendChild(buttonCall);
            sound2(); //ringtone
            //modal.style.display = "block"; //show modal
        }

        if (btnend) {
            //btnend.appendChild(icon);
            btnend.style.display = "inline-block";
        } else {
            var buttonEnd = document.createElement('button');
            buttonEnd.className = "btn btn-danger btn-circle btn-lg btn-sm";
            buttonEnd.id = "refuse-call";
            //buttonEnd.appendChild(icon);
            item.appendChild(buttonEnd);
        }
        return;

    }

    if (event.data.callaccepted) {

        //document.getElementById('new-open-video').style.display = "none";
        createStreams();
        document.getElementById('end-call').style.display = "";

        document.getElementById('call-video').style.display = "none";
        document.getElementById('call-audio').style.display = "none";


    }

    if (event.data.endStreamForAll) {
        endStreams();
        //document.getElementById('new-open-video').style.display = "";
        //document.getElementById('hide-video').style.display = "none";

        document.getElementById('call-video').style.display = "";
        document.getElementById('call-audio').style.display = "";

        document.getElementById('end-call').style.display = "none";
        document.getElementById('toggle-video').style.display = "none";
        document.getElementById('mute-audio').style.display = "none";
    }


    if (event.data.audioaccepted) {
        document.getElementById('toggle-video').style.display = "";        
        document.getElementById('mute-audio').style.display = "";
        document.getElementById('end-call').style.display = "";

        document.getElementById('call-audio').style.display = "none";
        document.getElementById('call-video').style.display = "none";

        // show end call (both sides)
    }

    if (event.data.audioCall) {

        modal.style.display = "block"; //show modal
        var acceptaudio = document.getElementById("accepting-audio");
        var item = document.getElementById('call-wrapper');

        if (acceptaudio) {
            sound2(); //ringtone
        } else {
            sound2(); //ringtone
            var buttonCall2 = document.createElement('button');
            buttonCall2.className = "btn btn-success btn-circle btn-lg btn-sm";
            buttonCall2.id = "accepting-audio";
            item.appendChild(buttonCall2);
        }
        return;
    }

    /* typing codes */

    if (event.data.typing) {
        appendDIV(remote_name + ' is typing..', event.data.lastMessageUUID);
        return;
    }

    if (event.data.stoppedTyping) {
        var div = document.getElementById(event.data.lastMessageUUID);
        if (div) div.parentNode.removeChild(div);
        return;
    }

    if (event.data.modified) {
        var div = document.getElementById(event.data.lastMessageUUID);
        if (div) {
            div.innerHTML = event.data.message;
        }
        return;
    }

    if (event.data.removed) {
        var div = document.getElementById(event.data.lastMessageUUID);
        if (!div) return;
        div.parentNode.removeChild(div);
        return;
    }

    appendDIV(event.data.message, event.data.lastMessageUUID, null, local_tz);
};

connection.filesContainer = document.getElementById('file-container');

connection.onopen = function(event) {
    document.getElementById('share-file').disabled = false;
    document.getElementById('input-text-chat').disabled = false;
    document.getElementById('btn-leave-room').disabled = false;
    //document.getElementById('new-open-video').disabled = false;

    document.getElementById('call-video').disabled = false;
    document.getElementById('call-audio').disabled = false;

    local_name = connection.extra.name;
    remote_name = connection.peers[connection.getAllParticipants()[0]].extra.name;

    local_tz = connection.extra.tz;
    remote_tz = connection.peers[connection.getAllParticipants()[0]].extra.tz;

    appendDIV(remote_name + translator.getStr("OnlineNow"), 'online-warn'+Math.floor(Math.random()*(999-100+1)+100), remote_name, local_tz);
    //var warning_online = getElementById('online-warn').style.color = "#28a745";

    // document.getElementById('status-call').innerHTML = remote_name + translator.getStr("OnlineNow");
    // document.getElementById('status-call').style.color = "#28a745";
    // document.getElementById('status-call').style.fontWeight = "600";
};

connection.onclose = function() {
    if (connection.getAllParticipants().length) {
        //document.querySelector('h1').innerHTML = 'You are still connected with: ' + connection.getAllParticipants().join(', ');
        //document.getElementById("status-call").innerHTML = 'You are still connected with: ' + connection.getAllParticipants().join(', ');
        alert('Seems the user disconnected.');
    } else {
        // document.getElementById("status-call").innerHTML = translator.getStr("NoOneOnline");
        // document.getElementById("status-call").style.color = "#212529";
        // document.getElementById("status-call").style.fontWeight = "400";
        appendDIV(translator.getStr("NoOneOnline"), 'offline-warn'+Math.floor(Math.random()*(999-100+1)+100), remote_name, local_tz);
        //document.getElementById('new-open-video').style.display = "none";

        //document.getElementById('new-open-video').disabled = true;
        document.getElementById('call-video').disabled = true;
        document.getElementById('call-audio').disabled = true;
        //document.getElementById('mute-audio').style.display = "none";

        document.getElementById('call-audio').style.display = "";
        document.getElementById('call-video').style.display = "";

        document.getElementById('end-call').style.display = "none";
        document.getElementById('toggle-video').style.display = "none";
        
        alert('Seems your connection failed. Refresh the page and try again.');
    }

};

connection.onUserStatusChanged = function(event) {
    if (connection.userid != event.userid) {

        if (event.status=="offline") {
            var element = document.querySelectorAll('[data-userid="'+event.userid+'"]');
            //var element = document.querySelectorAll('[data-userid]');
            if (element[0]) {
                element[0].remove(function(){
                    console.log('removed');
                    // to apply a message here
                });
            }
        }
    }
};

connection.onEntireSessionClosed = function(event) {
    document.getElementById('share-file').disabled = true;
    document.getElementById('input-text-chat').disabled = true;
    document.getElementById('btn-leave-room').disabled = true;

    document.getElementById('open-or-join-room').disabled = false;
    document.getElementById('open-room').disabled = false;
    document.getElementById('join-room').disabled = false;
    document.getElementById('room-id').disabled = false;

    connection.attachStreams.forEach(function(stream) {
        stream.stop();
    });

    // don't display alert for moderator
    if (connection.userid === event.userid) return;
    //document.querySelector('h1').innerHTML = 'Entire session has been closed by the moderator: ' + event.userid;
    //document.getElementById("status-call").innerHTML = "Entire session has been closed by the moderator.";

    alert('closed all');
};

connection.onUserIdAlreadyTaken = function(useridAlreadyTaken, yourNewUserId) {
    // seems room is already opened
    connection.join(useridAlreadyTaken);
};

function disableInputButtons() {
    document.getElementById('open-or-join-room').disabled = true;
    document.getElementById('open-room').disabled = true;
    document.getElementById('join-room').disabled = true;
    document.getElementById('room-id').disabled = true;
}

// ......................................................
// ......................Handling Params................
// ......................................................

(function() {
    var params = {},
        r = /([^&=]+)=?([^&]*)/g;

    function d(s) {
        return decodeURIComponent(s.replace(/\+/g, ' '));
    }
    var match, search = window.location.search;
    while (match = r.exec(search.substring(1)))
        params[d(match[1])] = d(match[2]);
    window.params = params;
})();

function makeid(req_id) {
  var id = parseInt(req_id) * 299999984911 + 193353194;
  return id.toString(36).replace('0.', '');
}

function isEmpty(obj) {
    for(var key in obj) {
        if(obj.hasOwnProperty(key))
            return false;
    }
    return true;
}

var roomid = '';
if (localStorage.getItem(connection.socketMessageEvent)) {
    roomid = localStorage.getItem(connection.socketMessageEvent);
} else {
    roomid = connection.token();
}


document.getElementById('room-id').value = roomid;
document.getElementById('room-id').onkeyup = function() {
    localStorage.setItem(connection.socketMessageEvent, this.value);
};

var hashString = location.hash.replace('#', '');
if (hashString.length && hashString.indexOf('comment-') == 0) {
    hashString = '';
}

var lang = params.lang;
var roomid = params.roomid;
var realroom = params.realroom;
var token = params.t;
var name = params.name;
if (!roomid && hashString.length) {
    roomid = hashString;
}

function toTimeZone(time, zone) {
    //var format = 'YYYY/MM/DD HH:mm:ss ZZ';
    var format = 'HH:mm A';
    return moment(time, format).tz(zone).format(format);
}



if (true) {
    
    document.getElementById("master-wrapper").style.display = "block";    

    connection.extra = {
        name: prompt("What is your nick?","Anonymous")
    };

    if (roomid && roomid.length) {
        document.getElementById('room-id').value = roomid;
        localStorage.setItem(connection.socketMessageEvent, roomid);

        // auto-join-room
        (function reCheckRoomPresence() {
            connection.checkPresence(roomid, function(isRoomExists) {
                if (isRoomExists) {
                    connection.join(roomid);
                    return;
                }
                setTimeout(reCheckRoomPresence, 4000);
            });
        })();

        //disableInputButtons();
    } else if (realroom && realroom.length) {

        document.getElementById('room-id').value = realroom;
        document.getElementById('room-id').onkeyup = function() {
            localStorage.setItem(connection.socketMessageEvent, this.value);
        };

        connection.open(realroom, function() {
            //do something after open room
        });

    } else {

    }
}

// Language Interface

if (lang) {
    var browserlang = lang;
} else {
    var browserlang = navigator.language || navigator.userLanguage;
}

var translator = new Language(getLanguageName(browserlang));

document.getElementById("input-text-chat").placeholder = translator.getStr("EnterTextChat");
document.getElementById("share-file").innerHTML = translator.getStr("ShareFile");
document.getElementById("btn-leave-room").innerHTML = translator.getStr("LeaveRoom");
//document.getElementById("status-call").innerHTML = translator.getStr("NoOneOnline");

document.getElementById("call-video").innerHTML = translator.getStr("CallVideo");
document.getElementById("call-audio").innerHTML = translator.getStr("CallAudio");
document.getElementById("end-call").innerHTML = translator.getStr("EndCall");



// if(navigator.connection &&
//    navigator.connection.type === 'cellular' &&
//    navigator.connection.downlinkMax <= 0.115) {
//   alert('2G is not supported. Please use a better internet service.');
// }


if (!isFirefox) {
    // ----------------------------------------------------
    // getStats codes goes here
    // ----------------------------------------------------

    connection.onPeerStateChanged = function(event) {
      if(event.iceConnectionState === 'connected' && event.signalingState === 'stable') {
        if(connection.peers[event.userid].gettingStats === true) {
          return;
        }
        connection.peers[event.userid].gettingStats = true; // do not duplicate
        var peer = connection.peers[event.userid].peer;
        var interval = 5000;
        //console.log(peer);

        if(DetectRTC.browser.name === 'Firefox') {
          getStats(peer, peer.getLocalStreams()[0].getTracks()[0], function(stats) {
            onGettingWebRTCStats(stats, event.userid);
          }, interval);
        } else {
          getStats(peer, function(stats) {
            onGettingWebRTCStats(stats, event.userid);
          }, interval);
        }
      }
    };
    function onGettingWebRTCStats(stats, remoteUserId) {
      if(!connection.peers[remoteUserId]) {
        stats.nomore();
      }
      var statsData = 'UserID: ' + remoteUserId + '\n';
      statsData += 'Bandwidth: ' + bytesToSize(stats.bandwidth.speed);
      statsData += '\n';
      statsData += 'Encryption: ' + stats.encryption;
      statsData += '\n';
      statsData += 'Codecs: ' + stats.audio.recv.codecs.concat(stats.video.recv.codecs).join(', ');
      statsData += '\n';
      statsData += 'Data: ' + bytesToSize(stats.audio.bytesReceived + stats.video.bytesReceived);
      statsData += '\n';
      statsData += 'ICE: ' + stats.connectionType.remote.candidateType.join(', ');
      statsData += '\n';
      statsData += 'Port: ' + stats.connectionType.remote.transport.join(', ');

      if (saveLogs) {
        addLog(statsData);  
      }

      console.log(statsData);
      
      // var div = getDivByUserId(remoteUserId);
      
      // if(!div) {
      //   return;
      // }
      // div.querySelector('h2').innerHTML = statsData.replace(/\n/g, '<br>');
    }
    function getDivByUserId(userid) {
      return document.querySelector('[data-userid="' + userid + '"]');
    }
    function bytesToSize(bytes) {
        var k = 1000;
        var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        if (bytes === 0) {
            return '0 Bytes';
        }
        var i = parseInt(Math.floor(Math.log(bytes) / Math.log(k)), 10);
        return (bytes / Math.pow(k, i)).toPrecision(3) + ' ' + sizes[i];
    }

}




//dragElement(document.getElementById(""));

function dragElement(elmnt) {
  var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
  if (document.getElementById(elmnt.id + "header")) {
    // if present, the header is where you move the DIV from:
    document.getElementById(elmnt.id + "header").onmousedown = dragMouseDown;
  } else {
    // otherwise, move the DIV from anywhere inside the DIV: 
    elmnt.onmousedown = dragMouseDown;
  }

  function dragMouseDown(e) {
    e = e || window.event;
    e.preventDefault();
    // get the mouse cursor position at startup:
    pos3 = e.clientX;
    pos4 = e.clientY;
    document.onmouseup = closeDragElement;
    // call a function whenever the cursor moves:
    document.onmousemove = elementDrag;
  }

  function elementDrag(e) {
    e = e || window.event;
    e.preventDefault();
    // calculate the new cursor position:
    pos1 = pos3 - e.clientX;
    pos2 = pos4 - e.clientY;
    pos3 = e.clientX;
    pos4 = e.clientY;
    // set the element's new position:
    elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
    elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
  }

  function closeDragElement() {
    // stop moving when mouse button is released:
    document.onmouseup = null;
    document.onmousemove = null;
  }
}

</script>

  <footer>
    <small id="send-message"></small>
  </footer>

</body>
</html>
